# JsonTaggedLogger

JsonTaggedLogger provides a log formatter that works in conjunction with ActiveSupport::TaggedLogging to product JSON-formatted log output.


```ruby
# Gemfile
gem 'json_tagged_logger'

# config/environments/production.rb
Rails.application.configure do
	# …
	config.log_tags = JsonTaggedLogger::LogTagsConfig.generate(:request_id, :host, ->(request) { { example: "proc" }.to_json })
	logger = ActiveSupport::Logger.new(STDOUT)
	config.logger = JsonTaggedLogger::Logger.new(logger)
	# …
end

```


## Why?

On its own, ActiveSupport::TaggedLogging adds individual tags wrapped in squre brackets at the start of each line of log output, like so

```
[tag1] [tag2] : Foo bar
```

This is fine as far as it goes, but if you wish to use tagged logging with something like [Lograge](https://github.com/roidrage/lograge) to format your logs as JSON, there's no good way to get the tags into that json output, specially if any of your tags are generated by procs.

## How does it work?

First, JsonTaggedLogger::LogTags helps you generate an array lof log tags suitable for passing to Rails.application.config.log_tags to produce JSON logs. For example, given

```
Rails.application.config.log_tags = JsonTaggedLogger::LogTags.generate_config(:request_id, :host)
```

ActiveSupport::TaggedLogging will see the following log tags

```
[
  -> (request) { { request_id: request.send(:request_id) }.to_json },
  -> (request) { { host: request.send(:host) }.to_json }
]
```

Why is this an improvement over `Rails.application.config.log_tags = [:request_id, :host]`? Well, with the JsonTaggedLogger version, your logs will now contain

```
[{"request_id":"c31c3658-5b76-40cd-b583-d0fcbdee0710"}] [{"host":"127.0.0.1"}] log message
```

which `JsonTaggedLogger::Formatter` will turn into

```json
{"request_id":"c31c3658-5b76-40cd-b583-d0fcbdee0710","host":"127.0.0.1","msg":"log message"}
```

Lovely, eh?

The real advantage comes when you have more complicated procs that generage your log tags. So long as your proc produces a JSON string, `JsonTaggedLogger::Formatter` will be able to extract it from the tag and add it to the log hash.

```ruby
class UserInfoLogTag
  def self.user_info
		lambda do |request|
		  user_info = build_user_info_from_session(request) # build user info from request by inspecting session, etc
			{ user_info: user_info }.to_json
		end
  end

	private

	def self.build_user_info_from_session(request)
	  # left as an exercise for the reader
	end
end

Rails.application.config.log_tags = [ :request_id, :host, UserInfoLogTag.user_info ]
```

That will get you

```
{"request_id":"c31c3658-5b76-40cd-b583-d0fcbdee0710","host":"127.0.0.1","user_info":{"user_id":"1234","user_email":"user@example.com"},"msg":"log message"}
```

